<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invent치rio</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

header {
  background: #1976d2;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-size: 18px;
}

#search {
  width: 95%;
  padding: 10px;
  margin: 10px;
  font-size: 16px;
}

.list {
  padding: 10px;
}

.item {
  background: #fff;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
}

.btn {
  padding: 8px 12px;
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 5px;
}

#form {
  display: none;
  padding: 10px;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #1976d2;
  display: flex;
}

footer button {
  flex: 1;
  border: none;
  padding: 12px;
  color: #fff;
  background: none;
  font-size: 16px;
}
</style>
</head>

<body>

<header>Estoque / Invent치rio</header>

<input id="search" placeholder="Buscar produto...">

<div class="list" id="lista"></div>

<div id="form">
  <h3>Invent치rio</h3>

  <input id="codigo" placeholder="C칩digo">
  <input id="descricao" placeholder="Descri칞칚o" readonly>
  <input id="qtd_atual" placeholder="Qtd Atual" readonly>

  <!-- Quantidade invent치rio -->
  <input
    id="contagem1"
    placeholder="Quantidade (Invent치rio)"
    type="number"
    inputmode="numeric"
    pattern="[0-9]*"
  >

  <button class="btn" id="btnSalvar" onclick="salvar()">Salvar</button>
</div>

<div id="scanner" style="display:none"></div>

<footer>
  <button onclick="listar()">In칤cio</button>
  <button onclick="abrirScanner()">游닝 C칩digo</button>
  <button onclick="novo()">Novo</button>
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzewZfLbLMdcEGXCeCWUDTAF9cxLXTutUvTQ_L2GjRziLjJeH39ghSrtYX4CnAu7YY/exec";

let itens = [];
let itemAtual = null;
let salvando = false;

// LISTAR
function listar() {
  form.style.display = "none";
  scanner.style.display = "none";
  lista.style.display = "block";

  fetch(API_URL + "?action=listar")
    .then(r => r.json())
    .then(resp => {
      itens = (resp.items || []);
      render(itens);
    })
    .catch(() => render([]));
}

// RENDER
function render(data) {
  lista.innerHTML = "";

  data.forEach(i => {
    lista.innerHTML += `
      <div class="item">
        <strong>${i.descricao || ""}</strong><br>
        C칩digo: ${i.codigo_barras || ""}<br>
        Qtd invent치rio: ${i.qtd_inventario || ""}
      </div>
    `;
  });

  if (!data.length) {
    lista.innerHTML = `<div class="item"><strong>Nenhum lan칞amento ainda.</strong></div>`;
  }
}

// NOVO
function novo() {
  itemAtual = null;
  lista.style.display = "none";
  scanner.style.display = "none";
  form.style.display = "block";

  codigo.value = "";
  descricao.value = "";
  qtd_atual.value = "";
  contagem1.value = "";

  setTimeout(() => codigo.focus(), 50);
}

// BUSCAR PRODUTO
function buscarProdutoPorCodigo(raw) {
  const code = (raw || "").trim();
  if (!code) return;

  itemAtual = null;
  descricao.value = "";
  qtd_atual.value = "";

  fetch(API_URL + "?action=buscar&codigo=" + encodeURIComponent(code))
    .then(r => r.json())
    .then(d => {
      if (!d || d.notFound) {
        descricao.value = "Produto n칚o encontrado";
        return;
      }

      itemAtual = d;
      codigo.value = d.codigo_barras || code;
      descricao.value = d.descricao || "";
      qtd_atual.value = d.quantidade ?? "";

      setTimeout(() => contagem1.focus(), 50);
    });
}

// EVENTOS DO C칍DIGO
codigo.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    buscarProdutoPorCodigo(codigo.value);
  }
});

codigo.addEventListener("blur", () => {
  if (codigo.value.trim()) buscarProdutoPorCodigo(codigo.value);
});

// 游댠 AUTO-SALVAR AO PRESSIONAR ENTER NA QUANTIDADE
contagem1.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    salvar();
  }
});

// SALVAR
function salvar() {
  if (salvando) return;

  if (!itemAtual) return alert("Produto inv치lido.");
  if (!contagem1.value.trim()) return alert("Informe a quantidade.");

  salvando = true;
  btnSalvar.disabled = true;
  btnSalvar.innerText = "Salvando...";

  const payload = {
    action: "salvar",
    codigo_barras: itemAtual.codigo_barras,
    descricao: itemAtual.descricao,
    modelo: itemAtual.modelo,
    cor: itemAtual.cor,
    tamanho: itemAtual.tamanho,
    qtd_atual: itemAtual.quantidade,
    qtd_inventario: contagem1.value.trim()
  };

  fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
    .finally(() => {
      salvando = false;
      btnSalvar.disabled = false;
      btnSalvar.innerText = "Salvar";
    });

  novo();
  listar();
}

// SCANNER
function abrirScanner() {
  lista.style.display = "none";
  form.style.display = "none";
  scanner.style.display = "block";

  const qr = new Html5Qrcode("scanner");
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    code => {
      qr.stop().catch(()=>{});
      novo();
      codigo.value = code;
      buscarProdutoPorCodigo(code);
    }
  );
}

listar();
</script>

</body>
</html>
