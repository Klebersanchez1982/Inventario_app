<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invent√°rio</title>

<!-- Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

header {
  background: #1976d2;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-size: 18px;
}

#search {
  width: 95%;
  padding: 10px;
  margin: 10px;
  font-size: 16px;
}

.list {
  padding: 10px;
}

.item {
  background: #fff;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.item strong {
  display: block;
}

.btn {
  padding: 8px 12px;
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 5px;
}

.btn.small {
  padding: 6px 8px;
  font-size: 14px;
}

#form {
  display: none;
  padding: 10px;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #1976d2;
  display: flex;
}

footer button {
  flex: 1;
  border: none;
  padding: 12px;
  color: #fff;
  background: none;
  font-size: 16px;
}
</style>
</head>

<body>

<header>Estoque / Invent√°rio</header>

<input id="search" placeholder="Buscar produto...">

<div class="list" id="lista"></div>

<div id="form">
  <h3>Invent√°rio</h3>

  <input id="codigo" placeholder="C√≥digo">
  <input id="descricao" placeholder="Descri√ß√£o" readonly>
  <input id="qtd_atual" placeholder="Qtd Atual" readonly>

  <!-- Quantidade do invent√°rio = Contagem 1 -->
  <input id="contagem1" placeholder="Quantidade (Invent√°rio)">
  <input id="contagem2" placeholder="Contagem 2 (opcional)">
  <input id="contagem3" placeholder="Contagem 3 (opcional)">
  <input id="obs" placeholder="Observa√ß√£o (opcional)">

  <button class="btn" id="btnSalvar" onclick="salvar()">Salvar</button>
</div>

<div id="scanner" style="display:none"></div>

<footer>
  <button onclick="listar()">In√≠cio</button>
  <button onclick="abrirScanner()">üì∑ C√≥digo</button>
  <button onclick="novo()">Novo</button>
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxTi5AFX39uZnBetd1VLwPy-lYGqudUspXfA_zozonkhl9p2xDPsri1jfFtL9vGBi_e/exec";

let itens = [];
let itemAtual = null;
let salvando = false;

// LISTAR (mostra √∫ltimos lan√ßamentos do INVENTARIO)
function listar() {
  form.style.display = "none";
  scanner.style.display = "none";
  lista.style.display = "block";

  fetch(API_URL + "?action=listar")
    .then(r => r.json())
    .then(resp => {
      itens = (resp.items || []);
      render(itens);
    })
    .catch(() => render([]));
}

// RENDER
function render(data) {
  lista.innerHTML = "";

  data.forEach(i => {
    lista.innerHTML += `
      <div class="item">
        <div>
          <strong>${(i.descricao || "").toString()}</strong>
          <div style="font-size:14px;">C√≥digo: ${(i.codigo_barras || "")}</div>
          <div style="font-size:14px;">Qtd invent√°rio: ${(i.qtd_inventario ?? "")}</div>
        </div>
      </div>
    `;
  });

  if (!data.length) {
    lista.innerHTML = `<div class="item"><div><strong>Nenhum lan√ßamento ainda.</strong></div></div>`;
  }
}

// BUSCA NA LISTA (local)
search.addEventListener("input", e => {
  const t = e.target.value.toLowerCase();
  const filtered = itens.filter(i => JSON.stringify(i).toLowerCase().includes(t));
  render(filtered);
});

// NOVO (abre form e foca no c√≥digo)
function novo() {
  itemAtual = null;
  lista.style.display = "none";
  scanner.style.display = "none";
  form.style.display = "block";

  codigo.value = "";
  descricao.value = "";
  qtd_atual.value = "";
  contagem1.value = "";
  contagem2.value = "";
  contagem3.value = "";
  obs.value = "";

  setTimeout(() => codigo.focus(), 50);
}

// Buscar produto no CADASTRO_PRODUTOS e preencher
function buscarProdutoPorCodigo(raw) {
  const code = (raw || "").trim();
  if (!code) return;

  // limpa UI antes
  itemAtual = null;
  descricao.value = "";
  qtd_atual.value = "";

  fetch(API_URL + "?action=buscar&codigo=" + encodeURIComponent(code))
    .then(r => r.json())
    .then(d => {
      if (!d || d.notFound) {
        itemAtual = null;
        descricao.value = "Produto n√£o encontrado no cadastro";
        qtd_atual.value = "";
        return;
      }

      // guarda tudo (mesmo que n√£o tenha campos no layout)
      itemAtual = d;

      // preenche campos do layout
      codigo.value = d.codigo_barras || code;
      descricao.value = d.descricao || "";
      qtd_atual.value = (d.quantidade ?? "");

      // j√° foca na quantidade do invent√°rio
      setTimeout(() => contagem1.focus(), 50);
    })
    .catch(() => {
      itemAtual = null;
      descricao.value = "Erro ao buscar (API)";
    });
}

// Ao digitar c√≥digo: Enter ou sair do campo dispara busca
codigo.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    buscarProdutoPorCodigo(codigo.value);
  }
});
codigo.addEventListener("blur", () => {
  // busca ao sair do campo (se tiver algo)
  if ((codigo.value || "").trim()) buscarProdutoPorCodigo(codigo.value);
});

// SALVAR (salva no INVENTARIO e marca duplicados no servidor)
function salvar() {
  if (salvando) return;

  const code = (codigo.value || "").trim();
  if (!code) return alert("Informe o c√≥digo.");
  if (!itemAtual || itemAtual.notFound) return alert("Produto n√£o encontrado no CADASTRO_PRODUTOS.");

  const qtdInvent = (contagem1.value || "").trim();
  if (!qtdInvent) return alert("Informe a quantidade do invent√°rio (Contagem 1).");

  salvando = true;
  const btn = document.getElementById("btnSalvar");
  btn.disabled = true;
  btn.innerText = "Salvando...";

  const payload = {
    action: "salvar",
    codigo_barras: itemAtual.codigo_barras || code,
    descricao: itemAtual.descricao || "",
    modelo: itemAtual.modelo || "",
    cor: itemAtual.cor || "",
    tamanho: itemAtual.tamanho || "",
    qtd_atual: itemAtual.quantidade ?? "",
    qtd_inventario: qtdInvent,         // ‚úÖ usu√°rio s√≥ preenche isso
    observacao: (obs.value || "").trim(),

    // se quiser guardar as outras contagens no obs:
    // (mant√©m layout igual e n√£o perde informa√ß√£o)
    _c2: (contagem2.value || "").trim(),
    _c3: (contagem3.value || "").trim()
  };

  // Salvamento em segundo plano (libera mais r√°pido)
  fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(r => r.json())
    .then(resp => {
      if (resp && resp.ok === false) alert(resp.error || "Erro ao salvar.");
    })
    .catch(() => alert("Erro ao salvar (API)."))
    .finally(() => {
      salvando = false;
      btn.disabled = false;
      btn.innerText = "Salvar";
    });

  // j√° libera para o pr√≥ximo item (UX)
  novo();
  listar();
}

// SCANNER
function abrirScanner() {
  lista.style.display = "none";
  form.style.display = "none";
  scanner.style.display = "block";

  const qr = new Html5Qrcode("scanner");
  qr.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    code => {
      qr.stop().catch(()=>{});
      // abre form e busca
      novo();
      codigo.value = code;
      buscarProdutoPorCodigo(code);
    }
  );
}

// inicia
listar();
</script>

</body>
</html>
