<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invent√°rio</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #4f8cff;
  --bg: #f6f8fb;
  --card: #ffffff;
  --text: #1f2937;
  --muted: #6b7280;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  background: var(--card);
  padding: 16px;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
}

#search {
  width: calc(100% - 24px);
  margin: 12px;
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  font-size: 15px;
}

.list { padding: 12px; }

.item {
  background: var(--card);
  margin-bottom: 12px;
  padding: 14px;
  border-radius: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 6px 14px rgba(0,0,0,.06);
}

.item strong { font-weight: 600; }
.item small { color: var(--muted); }

.btn {
  padding: 10px 14px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 14px;
}

.btn.small { padding: 8px 10px; font-size: 13px; }

#form {
  display: none;
  padding: 14px;
}

input {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  font-size: 15px;
}

#scanner { padding: 12px; }

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: var(--card);
  display: flex;
  box-shadow: 0 -2px 10px rgba(0,0,0,.08);
}

footer button {
  flex: 1;
  border: none;
  padding: 14px;
  font-size: 15px;
  background: none;
  color: var(--primary);
  font-weight: 500;
}
</style>
</head>

<body>

<header>Estoque / Invent√°rio</header>

<input id="search" placeholder="Buscar produto...">

<div class="list" id="lista"></div>

<div id="form">
  <h3>Invent√°rio</h3>

  <input id="codigo" placeholder="C√≥digo">
  <input id="descricao" placeholder="Descri√ß√£o" readonly>
  <input id="modelo" placeholder="Modelo" readonly>
  <input id="cor" placeholder="Cor" readonly>
  <input id="tamanho" placeholder="Tamanho" readonly>
  <input id="qtd_atual" placeholder="Qtd Atual" readonly>
  <input id="contagem1" placeholder="Contagem 1">
  <input id="contagem2" placeholder="Contagem 2">
  <input id="contagem3" placeholder="Contagem 3">
  <input id="obs" placeholder="Observa√ß√£o">

  <button class="btn" id="btnSalvar" onclick="salvar()">Salvar</button>
</div>

<div id="scanner" style="display:none"></div>

<footer>
  <button onclick="listar()">In√≠cio</button>
  <button onclick="abrirScanner()">üì∑ C√≥digo</button>
  <button onclick="novo()">Novo</button>
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxTi5AFX39uZnBetd1VLwPy-lYGqudUspXfA_zozonkhl9p2xDPsri1jfFtL9vGBi_e/exec";

let itens = [];
let itemAtual = null;
let salvando = false;

// LISTAR
function listar() {
  document.getElementById("form").style.display = "none";
  document.getElementById("scanner").style.display = "none";
  document.getElementById("lista").style.display = "block";

  fetch(API_URL + "?action=listarProdutos")
    .then(r => r.json())
    .then(d => {
      itens = d;
      render(d);
    });
}

// RENDER
function render(data) {
  const div = document.getElementById("lista");
  div.innerHTML = "";

  data.forEach(i => {
    if (!i.codigo_barras) return;

    div.innerHTML += `
      <div class="item">
        <div>
          <strong>${i.descricao}</strong><br>
          <small>Qtd: ${i.qtd_atual}</small>
        </div>
        <button class="btn small" onclick='editar(${JSON.stringify(i)})'>Editar</button>
      </div>
    `;
  });
}

// BUSCA
document.getElementById("search").addEventListener("input", e => {
  const t = e.target.value.toLowerCase();
  render(itens.filter(i =>
    JSON.stringify(i).toLowerCase().includes(t)
  ));
});

// EDITAR
function editar(i) {
  itemAtual = i;
  document.getElementById("lista").style.display = "none";
  document.getElementById("form").style.display = "block";

  // Preenche os campos automaticamente com as informa√ß√µes do produto
  codigo.value = i.codigo_barras || "";
  descricao.value = i.descricao || "";
  modelo.value = i.modelo || "";
  cor.value = i.cor || "";
  tamanho.value = i.tamanho || "";
  qtd_atual.value = i.qtd_atual || "";
}

function novo() {
  itemAtual = {};
  document.getElementById("lista").style.display = "none";
  document.getElementById("form").style.display = "block";
}

// SALVAR
function salvar() {
  if (salvando) return;
  salvando = true;

  const btn = document.getElementById("btnSalvar");
  btn.disabled = true;
  btn.innerText = "Salvando...";

  const data = {
    action: "salvar",
    codigo_barras: codigo.value,
    descricao: descricao.value,
    modelo: modelo.value,
    cor: cor.value,
    tamanho: tamanho.value,
    qtd_atual: qtd_atual.value,  // Quantidade inserida pelo usu√°rio
    contagem_1: contagem1.value,
    contagem_2: contagem2.value,
    contagem_3: contagem3.value,
    observacao: obs.value,
    _row: itemAtual?._row
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  }).finally(() => {
    salvando = false;
    btn.disabled = false;
    btn.innerText = "Salvar";
  });

  // Verifica duplicidade de c√≥digo ap√≥s salvar
  verificarDuplicidade();

  limparFormulario();
  listar();
}

// LIMPA E LIBERA IMEDIATO
function limparFormulario() {
  itemAtual = null;
  codigo.value = "";
  descricao.value = "";
  modelo.value = "";
  cor.value = "";
  tamanho.value = "";
  qtd_atual.value = "";
  contagem1.value = "";
  contagem2.value = "";
  contagem3.value = "";
  obs.value = "";
  form.style.display = "none";
  lista.style.display = "block";
}

// SCANNER
function abrirScanner() {
  lista.style.display = "none";
  scanner.style.display = "block";

  const html5 = new Html5Qrcode("scanner");
  html5.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    code => {
      html5.stop();
      buscarCodigo(code);
    });
}

function buscarCodigo(codigoLido) {
  fetch(API_URL + "?action=buscar&codigo=" + codigoLido)
    .then(r => r.json())
    .then(d => {
      if (d.notFound) {
        novo();
        codigo.value = codigoLido;
      } else {
        editar(d);
      }
    });
}

// Fun√ß√£o para verificar duplicidade de c√≥digo
function verificarDuplicidade() {
  const sheet = SpreadsheetApp.getActive().getSheetByName("CADASTRO_PRODUTOS");
  const data = sheet.getDataRange().getValues();
  const codigos = {};

  for (let i = 1; i < data.length; i++) {  // Inicia da linha 2
    const codigo = data[i][0];  // A primeira coluna cont√©m o c√≥digo de barras
    if (codigos[codigo]) {
      // Pinta a linha de vermelho se houver duplicidade
      sheet.getRange(i + 1, 1, 1, sheet.getLastColumn()).setBackground("#FFCCCC");
      sheet.getRange(codigos[codigo], 1, 1, sheet.getLastColumn()).setBackground("#FFCCCC");
    } else {
      codigos[codigo] = i + 1;  // Armazena a linha onde o c√≥digo foi encontrado
    }
  }
}

listar();
</script>

</body>
</html>
