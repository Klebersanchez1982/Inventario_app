<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invent√°rio</title>

<!-- Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

header {
  background: #1976d2;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-size: 18px;
}

#search {
  width: 95%;
  padding: 10px;
  margin: 10px;
  font-size: 16px;
}

.list {
  padding: 10px;
}

.item {
  background: #fff;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
}

.btn {
  padding: 8px 12px;
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 5px;
}

#form {
  display: none;
  padding: 10px;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #1976d2;
  display: flex;
}

footer button {
  flex: 1;
  border: none;
  padding: 12px;
  color: #fff;
  background: none;
  font-size: 16px;
}
</style>
</head>

<body>

<header>Estoque / Invent√°rio</header>

<input id="search" placeholder="Buscar produto...">

<div class="list" id="lista"></div>

<div id="form">
  <h3>Invent√°rio</h3>

  <input id="codigo" placeholder="C√≥digo">
  <input id="descricao" placeholder="Descri√ß√£o" readonly>
  <input id="qtd_atual" placeholder="Qtd Atual" readonly>

  <!-- Quantidade com teclado num√©rico -->
  <input
    id="contagem1"
    placeholder="Quantidade (Invent√°rio)"
    type="number"
    inputmode="numeric"
    pattern="[0-9]*"
  >

  <input id="obs" placeholder="Observa√ß√£o (opcional)">

  <button class="btn" id="btnSalvar" onclick="salvar()">Salvar</button>
</div>

<div id="scanner" style="display:none"></div>

<footer>
  <button onclick="listar()">In√≠cio</button>
  <button onclick="abrirScanner()">üì∑ C√≥digo</button>
  <button onclick="novo()">Novo</button>
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxTi5AFX39uZnBetd1VLwPy-lYGqudUspXfA_zozonkhl9p2xDPsri1jfFtL9vGBi_e/exec";

let itemAtual = null;
let salvando = false;
let scannerAtivo = null;

// LISTAR
function listar() {
  form.style.display = "none";
  scanner.style.display = "none";
  lista.style.display = "block";
  lista.innerHTML = `<div class="item"><strong>Pronto para inventariar</strong></div>`;
}

// NOVO
function novo() {
  itemAtual = null;
  lista.style.display = "none";
  scanner.style.display = "none";
  form.style.display = "block";

  codigo.value = "";
  descricao.value = "";
  qtd_atual.value = "";
  contagem1.value = "";
  obs.value = "";

  setTimeout(() => codigo.focus(), 100);
}

// BUSCAR PRODUTO
function buscarProdutoPorCodigo(cod) {
  fetch(API_URL + "?action=buscar&codigo=" + encodeURIComponent(cod))
    .then(r => r.json())
    .then(d => {
      if (!d || d.notFound) {
        descricao.value = "Produto n√£o encontrado";
        itemAtual = null;
        return;
      }

      itemAtual = d;

      codigo.value = d.codigo_barras;
      descricao.value = d.descricao;
      qtd_atual.value = d.quantidade;

      setTimeout(() => contagem1.focus(), 100);
    });
}

// DISPARA BUSCA AO SAIR DO CAMPO OU ENTER
codigo.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    buscarProdutoPorCodigo(codigo.value.trim());
  }
});

codigo.addEventListener("blur", () => {
  if (codigo.value.trim()) buscarProdutoPorCodigo(codigo.value.trim());
});

// SALVAR
function salvar() {
  if (salvando) return;

  if (!itemAtual) return alert("Produto n√£o encontrado.");
  if (!contagem1.value.trim()) return alert("Informe a quantidade.");

  salvando = true;
  btnSalvar.disabled = true;
  btnSalvar.innerText = "Salvando...";

  const payload = {
    action: "salvar",
    codigo_barras: itemAtual.codigo_barras,
    descricao: itemAtual.descricao,
    modelo: itemAtual.modelo,
    cor: itemAtual.cor,
    tamanho: itemAtual.tamanho,
    qtd_atual: itemAtual.quantidade,
    qtd_inventario: contagem1.value.trim(),
    observacao: obs.value.trim()
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .finally(() => {
    salvando = false;
    btnSalvar.disabled = false;
    btnSalvar.innerText = "Salvar";

    // Ap√≥s salvar ‚Üí abre c√¢mera automaticamente
    abrirScanner();
  });
}

// SCANNER
function abrirScanner() {
  lista.style.display = "none";
  form.style.display = "none";
  scanner.style.display = "block";

  if (scannerAtivo) {
    scannerAtivo.stop().catch(()=>{});
  }

  scannerAtivo = new Html5Qrcode("scanner");
  scannerAtivo.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    code => {
      scannerAtivo.stop().catch(()=>{});
      novo();
      codigo.value = code;
      buscarProdutoPorCodigo(code);
    }
  );
}

// INICIAL
listar();
</script>

</body>
</html>
