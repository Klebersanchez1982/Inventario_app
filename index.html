<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invent√°rio</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

header {
  background: #1976d2;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-size: 18px;
}

#contador {
  background: #e3f2fd;
  padding: 8px;
  text-align: center;
  font-size: 14px;
}

#search {
  width: 95%;
  padding: 10px;
  margin: 10px;
  font-size: 16px;
}

.list {
  padding: 10px;
}

.item {
  background: #fff;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
}

#form {
  display: none;
  padding: 10px;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #1976d2;
  display: flex;
}

footer button {
  flex: 1;
  border: none;
  padding: 12px;
  color: #fff;
  background: none;
  font-size: 16px;
}
</style>
</head>

<body>

<header>Estoque / Invent√°rio</header>
<div id="contador">Itens inventariados: <strong id="total">0</strong></div>

<input id="search" placeholder="Buscar produto...">

<div class="list" id="lista"></div>

<div id="form">
  <h3>Invent√°rio</h3>

  <input id="codigo" placeholder="C√≥digo">
  <input id="descricao" placeholder="Descri√ß√£o" readonly>
  <input id="qtd_atual" placeholder="Qtd Atual" readonly>

  <input
    id="contagem1"
    placeholder="Quantidade (Invent√°rio)"
    type="number"
    inputmode="numeric"
    pattern="[0-9]*"
  >
</div>

<div id="scanner" style="display:none"></div>

<footer>
  <button onclick="listar()">In√≠cio</button>
  <button onclick="abrirScanner()">üì∑ C√≥digo</button>
  <button onclick="novo()">Novo</button>
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzewZfLbLMdcEGXCeCWUDTAF9cxLXTutUvTQ_L2GjRziLjJeH39ghSrtYX4CnAu7YY/exec";

let itens = [];
let itemAtual = null;
let salvando = false;
let totalInventariados = 0;
let scannerAtivo = null;

/* üîî SOM */
function beep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.frequency.value = 900;
  osc.connect(ctx.destination);
  osc.start();
  setTimeout(() => osc.stop(), 120);
}

/* üì≥ VIBRA√á√ÉO */
function vibrar() {
  if (navigator.vibrate) navigator.vibrate(120);
}

/* üî¢ CONTADOR */
function atualizarContador() {
  document.getElementById("total").innerText = totalInventariados;
}

/* LISTAR (apenas visualiza√ß√£o, n√£o usado no fluxo cont√≠nuo) */
function listar() {
  form.style.display = "none";
  scanner.style.display = "none";
  lista.style.display = "block";

  fetch(API_URL + "?action=listar")
    .then(r => r.json())
    .then(resp => {
      itens = (resp.items || []);
      render(itens);
    })
    .catch(() => render([]));
}

/* RENDER */
function render(data) {
  lista.innerHTML = "";

  if (!data.length) {
    lista.innerHTML = `<div class="item"><strong>Nenhum lan√ßamento ainda.</strong></div>`;
    return;
  }

  data.forEach(i => {
    lista.innerHTML += `
      <div class="item">
        <strong>${i.descricao || ""}</strong><br>
        C√≥digo: ${i.codigo_barras || ""}<br>
        Qtd invent√°rio: ${i.qtd_inventario || ""}
      </div>
    `;
  });
}

/* NOVO */
function novo() {
  itemAtual = null;
  lista.style.display = "none";
  scanner.style.display = "none";
  form.style.display = "block";

  codigo.value = "";
  descricao.value = "";
  qtd_atual.value = "";
  contagem1.value = "";

  setTimeout(() => codigo.focus(), 50);
}

/* BUSCAR PRODUTO */
function buscarProdutoPorCodigo(raw) {
  const code = (raw || "").trim();
  if (!code) return;

  fetch(API_URL + "?action=buscar&codigo=" + encodeURIComponent(code))
    .then(r => r.json())
    .then(d => {
      if (!d || d.notFound) {
        descricao.value = "Produto n√£o encontrado";
        return;
      }

      itemAtual = d;
      codigo.value = d.codigo_barras;
      descricao.value = d.descricao;
      qtd_atual.value = d.quantidade ?? "";

      setTimeout(() => contagem1.focus(), 50);
    });
}

/* EVENTOS */
codigo.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    buscarProdutoPorCodigo(codigo.value);
  }
});

codigo.addEventListener("blur", () => {
  if (codigo.value.trim()) buscarProdutoPorCodigo(codigo.value);
});

/* ENTER SALVA */
contagem1.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    salvar();
  }
});

/* SALVAR ‚Äì FLUXO CONT√çNUO EST√ÅVEL */
function salvar() {
  if (salvando || !itemAtual) return;
  if (!contagem1.value.trim()) return;

  salvando = true;

  const payload = {
    action: "salvar",
    codigo_barras: itemAtual.codigo_barras,
    descricao: itemAtual.descricao,
    modelo: itemAtual.modelo,
    cor: itemAtual.cor,
    tamanho: itemAtual.tamanho,
    qtd_atual: itemAtual.quantidade,
    qtd_inventario: contagem1.value.trim()
  };

  fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(r => r.json())
    .then(resp => {
      if (resp && resp.ok === false) {
        alert(resp.error || "Erro ao salvar");
        return;
      }

      // ‚úÖ contador persistente
      totalInventariados++;
      atualizarContador();

      // üîî feedback
      beep();
      vibrar();

      // üßπ limpa campos
      codigo.value = "";
      descricao.value = "";
      qtd_atual.value = "";
      contagem1.value = "";
      itemAtual = null;

      // üîÅ reabre c√¢mera com seguran√ßa
      setTimeout(() => abrirScanner(), 400);
    })
    .catch(() => alert("Erro ao salvar (API)"))
    .finally(() => salvando = false);
}

/* SCANNER CONT√çNUO */
function abrirScanner() {
  lista.style.display = "none";
  form.style.display = "none";
  scanner.style.display = "block";

  if (scannerAtivo) {
    scannerAtivo.stop().catch(() => {});
    scannerAtivo = null;
  }

  setTimeout(() => {
    scannerAtivo = new Html5Qrcode("scanner");
    scannerAtivo.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      code => {
        scannerAtivo.stop().catch(() => {});
        scannerAtivo = null;

        form.style.display = "block";
        scanner.style.display = "none";

        codigo.value = code;
        buscarProdutoPorCodigo(code);
      }
    );
  }, 200);
}

/* IN√çCIO */
listar();
</script>

</body>
</html>
