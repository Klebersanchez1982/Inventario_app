<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invent치rio</title>

<!-- Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

header {
  background: #1976d2;
  color: #fff;
  padding: 12px;
  text-align: center;
  font-size: 18px;
}

#search {
  width: 95%;
  padding: 10px;
  margin: 10px;
  font-size: 16px;
}

.list {
  padding: 10px;
}

.item {
  background: #fff;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.item strong {
  display: block;
}

.btn {
  padding: 8px 12px;
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 5px;
}

.btn.small {
  padding: 6px 8px;
  font-size: 14px;
}

#form {
  display: none;
  padding: 10px;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 8px;
}

footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #1976d2;
  display: flex;
}

footer button {
  flex: 1;
  border: none;
  padding: 12px;
  color: #fff;
  background: none;
  font-size: 16px;
}
</style>
</head>

<body>

<header>Estoque / Invent치rio</header>

<input id="search" placeholder="Buscar produto...">

<div class="list" id="lista"></div>

<div id="form">
  <h3>Invent치rio</h3>

  <input id="codigo" placeholder="C칩digo">
  <input id="descricao" placeholder="Descri칞칚o">
  <input id="qtd_atual" placeholder="Qtd Atual">
  <input id="contagem1" placeholder="Contagem 1">
  <input id="contagem2" placeholder="Contagem 2">
  <input id="contagem3" placeholder="Contagem 3">
  <input id="obs" placeholder="Observa칞칚o">

  <button class="btn" onclick="salvar()">Salvar</button>
</div>

<div id="scanner" style="display:none"></div>

<footer>
  <button onclick="listar()">In칤cio</button>
  <button onclick="abrirScanner()">游닝 C칩digo</button>
  <button onclick="novo()">Novo</button>
</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxTi5AFX39uZnBetd1VLwPy-lYGqudUspXfA_zozonkhl9p2xDPsri1jfFtL9vGBi_e/exec";

let itens = [];
let itemAtual = null;

// LISTAR
function listar() {
  document.getElementById("form").style.display = "none";
  document.getElementById("scanner").style.display = "none";
  document.getElementById("lista").style.display = "block";

  fetch(API_URL + "?action=listar")
    .then(r => r.json())
    .then(d => {
      itens = d;
      render(d);
    });
}

// RENDER
function render(data) {
  const div = document.getElementById("lista");
  div.innerHTML = "";

  data.forEach(i => {
    if (!i.codigo_novo && !i.codigo_antigo) return;

    div.innerHTML += `
      <div class="item">
        <div>
          <strong>${i.descricao_nova || i.descricao_antiga}</strong>
          Qtd: ${i.qtd_atual}
        </div>
        <button class="btn small" onclick='editar(${JSON.stringify(i)})'>九勇</button>
      </div>
    `;
  });
}

// BUSCA
document.getElementById("search").addEventListener("input", e => {
  const t = e.target.value.toLowerCase();
  render(itens.filter(i =>
    JSON.stringify(i).toLowerCase().includes(t)
  ));
});

// EDITAR
function editar(i) {
  itemAtual = i;
  document.getElementById("lista").style.display = "none";
  document.getElementById("form").style.display = "block";

  codigo.value = i.codigo_novo || i.codigo_antigo || "";
  descricao.value = i.descricao_nova || i.descricao_antiga || "";
  qtd_atual.value = i.qtd_atual || "";
}

// NOVO
function novo() {
  itemAtual = {};
  document.getElementById("lista").style.display = "none";
  document.getElementById("form").style.display = "block";
}

// SALVAR
function salvar() {
  const data = {
    action: "salvar",
    codigo_novo: codigo.value,
    descricao_nova: descricao.value,
    qtd_atual: qtd_atual.value,
    contagem_1: contagem1.value,
    contagem_2: contagem2.value,
    contagem_3: contagem3.value,
    observacao: obs.value,
    _row: itemAtual?._row
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  }).then(() => {
    alert("Salvo!");
    listar();
  });
}

// SCANNER
function abrirScanner() {
  document.getElementById("lista").style.display = "none";
  document.getElementById("scanner").style.display = "block";

  const scanner = new Html5Qrcode("scanner");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    code => {
      scanner.stop();
      buscarCodigo(code);
    }
  );
}

function buscarCodigo(codigo) {
  fetch(API_URL + "?action=buscar&codigo=" + codigo)
    .then(r => r.json())
    .then(d => {
      if (d.notFound) {
        novo();
        document.getElementById("codigo").value = codigo;
      } else {
        editar(d);
      }
    });
}

listar();
</script>

</body>
</html>
